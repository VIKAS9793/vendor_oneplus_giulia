# Copyright (C) 2024 The LineageOS Project
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.

on init
    # Create firmware directories
    mkdir /odm/firmware 0771 system system
    mkdir /odm/firmware/tp 0771 system system
    mkdir /odm/firmware/ufs 0771 system system
    mkdir /odm/firmware/fastchg 0771 system system

on fs
    # Mount firmware partitions
    wait /dev/block/bootdevice/by-name/oplusreserve1
    mount ext4 /dev/block/bootdevice/by-name/oplusreserve1 /mnt/vendor/oplusreserve ro

on post-fs-data
    # UFS Firmware
    start vendor.move_ufs_fw
    
    # Touchscreen Firmware
    chown system system /odm/firmware/tp
    chmod 0771 /odm/firmware/tp
    restorecon_recursive /odm/firmware/tp
    
    # FastChg Firmware
    chown system system /odm/firmware/fastchg
    chmod 0771 /odm/firmware/fastchg
    restorecon_recursive /odm/firmware/fastchg

    # SIPA Audio Firmware
    chmod 0644 /odm/firmware/sipa.bin
    chown system system /odm/firmware/sipa.bin

# UFS Firmware copy service
service vendor.move_ufs_fw /odm/firmware/ufs/move_target_ufs_fw_to_oplusreserve1.sh
    class main
    user root
    group root
    disabled
    oneshot

on property:sys.boot_completed=1
    # Load touchscreen firmware based on variant
    write /proc/touchpanel/tp_fw_update 0

on property:vendor.fastchg.fw_update=1
    # Update fast charging firmware
    write /proc/fastchg_fw_update 1 